# å¯¼å…¥æ‰€æœ‰ä¾èµ–åº“
from pydantic import BaseModel
from typing import Optional
import logging
import os
import requests
from bs4 import BeautifulSoup
from gtts import gTTS
from moviepy.editor import AudioFileClip, ImageClip
from langchain.chat_models import ChatDeepSeek
from langchain.schema import HumanMessage
from langgraph.graph import StateGraph, END

# -------------------------- 1. å…¨å±€é…ç½® --------------------------
# DeepSeekå¤§æ¨¡å‹é…ç½®ï¼ˆæ›¿æ¢ä¸ºä½ çš„APIå¯†é’¥ï¼‰
DEEPSEEK_API_KEY = "sk-fcf857583a554b7885233424fe43d70a"
LLM_MODEL = "deepseek-chat"

# æ–‡ä»¶è·¯å¾„é…ç½®
OUTPUT_DIR = "output"  # ç”Ÿæˆæ–‡ä»¶å­˜å‚¨ç›®å½•
LOG_DIR = "logs"       # æ—¥å¿—å­˜å‚¨ç›®å½•
BACKGROUND_IMAGE = "background.jpg"  # è§†é¢‘èƒŒæ™¯å›¾ç‰‡ï¼ˆéœ€æ”¾åœ¨é¡¹ç›®æ ¹ç›®å½•ï¼‰

# åˆ›å»ºå¿…è¦ç›®å½•ï¼ˆä¸å­˜åœ¨åˆ™è‡ªåŠ¨ç”Ÿæˆï¼‰
os.makedirs(OUTPUT_DIR, exist_ok=True)
os.makedirs(LOG_DIR, exist_ok=True)

# æ—¥å¿—é…ç½®ï¼ˆè®°å½•æµç¨‹çŠ¶æ€ï¼Œä¾¿äºè°ƒè¯•ï¼‰
logging.basicConfig(
    filename=os.path.join(LOG_DIR, "workflow.log"),
    level=logging.INFO,
    format="%(asctime)s - %(levelname)s - %(message)s"
)

# -------------------------- 2. å·¥ä½œæµçŠ¶æ€æ¨¡å‹ --------------------------
class WorkflowState(BaseModel):
    """ç»Ÿä¸€ç®¡ç†å„èŠ‚ç‚¹è¾“å…¥/è¾“å‡ºæ•°æ®ï¼Œå®ç°æ¨¡å—é—´æ•°æ®æµè½¬"""
    # çˆ¬è™«èŠ‚ç‚¹ç›¸å…³
    raw_text: Optional[str] = None  # çˆ¬å–çš„åŸå§‹æ–‡æœ¬
    crawl_success: bool = False     # çˆ¬å–çŠ¶æ€ï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰
    
    # æ‘˜è¦ç”ŸæˆèŠ‚ç‚¹ç›¸å…³
    summary_text: Optional[str] = None  # ç”Ÿæˆçš„æ ¸å¿ƒæ‘˜è¦
    summary_success: bool = False       # æ‘˜è¦çŠ¶æ€
    
    # TTSèŠ‚ç‚¹ç›¸å…³
    audio_path: Optional[str] = None  # éŸ³é¢‘æ–‡ä»¶è·¯å¾„
    tts_success: bool = False         # TTSçŠ¶æ€
    
    # è§†é¢‘åˆæˆèŠ‚ç‚¹ç›¸å…³
    video_path: Optional[str] = None  # æœ€ç»ˆè§†é¢‘è·¯å¾„
    video_success: bool = False       # è§†é¢‘åˆæˆçŠ¶æ€
    
    # å…¨å±€é”™è¯¯ä¿¡æ¯
    error_msg: Optional[str] = None  # å­˜å‚¨æµç¨‹ä¸­çš„é”™è¯¯è¯¦æƒ…

# -------------------------- 3. æ ¸å¿ƒèŠ‚ç‚¹é€»è¾‘ --------------------------
def crawl_node(state: WorkflowState) -> WorkflowState:
    """çˆ¬è™«èŠ‚ç‚¹ï¼šä»ç›®æ ‡URLæå–çº¯æ–‡æœ¬ï¼Œè¿‡æ»¤HTMLæ ‡ç­¾"""
    logging.info("å¯åŠ¨çˆ¬è™«èŠ‚ç‚¹")
    target_url = "https://example.com"  # å¯æ›¿æ¢ä¸ºå®é™…ç›®æ ‡URL
    
    try:
        # å‘é€HTTPè¯·æ±‚ï¼ˆè¶…æ—¶10ç§’ï¼‰
        response = requests.get(target_url, timeout=10)
        response.raise_for_status()  # æŠ›å‡ºHTTPé”™è¯¯ï¼ˆå¦‚404ã€500ï¼‰
        
        # è§£æHTMLå¹¶æå–æ–‡æœ¬
        soup = BeautifulSoup(response.text, "html.parser")
        raw_text = soup.get_text().strip()
        
        # è¿‡æ»¤æ— æ•ˆæ–‡æœ¬ï¼ˆé•¿åº¦å°äº50å­—ç¬¦è§†ä¸ºæ— æ•ˆï¼‰
        if len(raw_text) < 50:
            raise ValueError(f"çˆ¬å–æ–‡æœ¬è¿‡çŸ­ï¼ˆä»…{len(raw_text)}å­—ç¬¦ï¼‰")
        
        logging.info(f"çˆ¬è™«èŠ‚ç‚¹æ‰§è¡ŒæˆåŠŸï¼Œæ–‡æœ¬é•¿åº¦ï¼š{len(raw_text)}å­—ç¬¦")
        return WorkflowState(
            **state.dict(),
            raw_text=raw_text,
            crawl_success=True
        )
    except Exception as e:
        error_detail = f"çˆ¬è™«èŠ‚ç‚¹å¤±è´¥ï¼š{str(e)}"
        logging.error(error_detail)
        return WorkflowState(**state.dict(), error_msg=error_detail)

def summary_node(state: WorkflowState) -> WorkflowState:
    """æ‘˜è¦ç”ŸæˆèŠ‚ç‚¹ï¼šè°ƒç”¨DeepSeekå¤§æ¨¡å‹ç”Ÿæˆ100å­—å†…æ ¸å¿ƒæ‘˜è¦"""
    logging.info("å¯åŠ¨æ‘˜è¦ç”ŸæˆèŠ‚ç‚¹")
    
    # å‰ç½®æ ¡éªŒï¼šçˆ¬è™«å¤±è´¥åˆ™è·³è¿‡
    if not state.crawl_success:
        error_detail = "æ‘˜è¦èŠ‚ç‚¹è·³è¿‡ï¼šçˆ¬è™«æœªæˆåŠŸæ‰§è¡Œ"
        logging.warning(error_detail)
        return WorkflowState(**state.dict(), error_msg=error_detail)
    
    try:
        # åˆå§‹åŒ–å¤§æ¨¡å‹å®¢æˆ·ç«¯
        llm = ChatDeepSeek(
            api_key=DEEPSEEK_API_KEY,
            model=LLM_MODEL,
            temperature=0.6  # æ§åˆ¶éšæœºæ€§ï¼ˆ0-1ï¼Œå€¼è¶Šå°è¶Šç¨³å®šï¼‰
        )
        
        # æ„å»ºæç¤ºè¯å¹¶è°ƒç”¨æ¨¡å‹
        prompt = f"å°†ä»¥ä¸‹æ–‡æœ¬æ€»ç»“ä¸º100å­—å†…æ ¸å¿ƒæ‘˜è¦ï¼š\n{state.raw_text}"
        response = llm([HumanMessage(content=prompt)])
        summary_text = response.content.strip()
        
        logging.info("æ‘˜è¦ç”ŸæˆèŠ‚ç‚¹æ‰§è¡ŒæˆåŠŸ")
        return WorkflowState(
            **state.dict(),
            summary_text=summary_text,
            summary_success=True
        )
    except Exception as e:
        error_detail = f"æ‘˜è¦èŠ‚ç‚¹å¤±è´¥ï¼š{str(e)}"
        logging.error(error_detail)
        return WorkflowState(**state.dict(), error_msg=error_detail)

def tts_node(state: WorkflowState) -> WorkflowState:
    """TTSèŠ‚ç‚¹ï¼šå°†æ‘˜è¦æ–‡æœ¬è½¬æ¢ä¸ºä¸­æ–‡éŸ³é¢‘ï¼ˆMP3æ ¼å¼ï¼‰"""
    logging.info("å¯åŠ¨TTSèŠ‚ç‚¹")
    
    # å‰ç½®æ ¡éªŒï¼šæ‘˜è¦å¤±è´¥åˆ™è·³è¿‡
    if not state.summary_success:
        error_detail = "TTSèŠ‚ç‚¹è·³è¿‡ï¼šæ‘˜è¦æœªæˆåŠŸæ‰§è¡Œ"
        logging.warning(error_detail)
        return WorkflowState(**state.dict(), error_msg=error_detail)
    
    try:
        # éŸ³é¢‘è¾“å‡ºè·¯å¾„
        audio_path = os.path.join(OUTPUT_DIR, "summary_audio.mp3")
        
        # ç”Ÿæˆä¸­æ–‡éŸ³é¢‘ï¼ˆæ­£å¸¸è¯­é€Ÿï¼‰
        tts = gTTS(text=state.summary_text, lang="zh-CN", slow=False)
        tts.save(audio_path)
        
        logging.info(f"TTSèŠ‚ç‚¹æ‰§è¡ŒæˆåŠŸï¼ŒéŸ³é¢‘è·¯å¾„ï¼š{audio_path}")
        return WorkflowState(
            **state.dict(),
            audio_path=audio_path,
            tts_success=True
        )
    except Exception as e:
        error_detail = f"TTSèŠ‚ç‚¹å¤±è´¥ï¼š{str(e)}"
        logging.error(error_detail)
        return WorkflowState(**state.dict(), error_msg=error_detail)

def video_synthesis_node(state: WorkflowState) -> WorkflowState:
    """è§†é¢‘åˆæˆèŠ‚ç‚¹ï¼šç»“åˆéŸ³é¢‘ä¸èƒŒæ™¯å›¾ç‰‡ç”ŸæˆMP4è§†é¢‘"""
    logging.info("å¯åŠ¨è§†é¢‘åˆæˆèŠ‚ç‚¹")
    
    # å‰ç½®æ ¡éªŒï¼šTTSå¤±è´¥åˆ™è·³è¿‡
    if not state.tts_success:
        error_detail = "è§†é¢‘èŠ‚ç‚¹è·³è¿‡ï¼šTTSæœªæˆåŠŸæ‰§è¡Œ"
        logging.warning(error_detail)
        return WorkflowState(**state.dict(), error_msg=error_detail)
    
    try:
        # æ ¡éªŒèƒŒæ™¯å›¾ç‰‡æ˜¯å¦å­˜åœ¨
        if not os.path.exists(BACKGROUND_IMAGE):
            raise FileNotFoundError(f"èƒŒæ™¯å›¾ç‰‡ä¸å­˜åœ¨ï¼š{BACKGROUND_IMAGE}ï¼ˆéœ€æ”¾åœ¨é¡¹ç›®æ ¹ç›®å½•ï¼‰")
        
        # è§†é¢‘è¾“å‡ºè·¯å¾„
        video_path = os.path.join(OUTPUT_DIR, "final_video.mp4")
        
        # åŠ è½½éŸ³é¢‘å’Œå›¾ç‰‡
        audio_clip = AudioFileClip(state.audio_path)
        image_clip = ImageClip(BACKGROUND_IMAGE)
        
        # åŒæ­¥è§†é¢‘æ—¶é•¿ä¸éŸ³é¢‘ä¸€è‡´ï¼ˆ24fpså¸§ç‡ï¼‰
        image_clip = image_clip.set_duration(audio_clip.duration).set_fps(24)
        video_clip = image_clip.set_audio(audio_clip)
        
        # å¯¼å‡ºè§†é¢‘ï¼ˆMP4æ ‡å‡†ç¼–ç ï¼Œå…¼å®¹æ€§å¥½ï¼‰
        video_clip.write_videofile(video_path, codec="libx264", audio_codec="aac")
        
        # é‡Šæ”¾èµ„æº
        audio_clip.close()
        image_clip.close()
        video_clip.close()
        
        logging.info(f"è§†é¢‘åˆæˆèŠ‚ç‚¹æ‰§è¡ŒæˆåŠŸï¼Œè§†é¢‘è·¯å¾„ï¼š{video_path}")
        return WorkflowState(
            **state.dict(),
            video_path=video_path,
            video_success=True
        )
    except Exception as e:
        error_detail = f"è§†é¢‘èŠ‚ç‚¹å¤±è´¥ï¼š{str(e)}"
        logging.error(error_detail)
        return WorkflowState(**state.dict(), error_msg=error_detail)

# -------------------------- 4. å·¥ä½œæµæ­å»ºä¸æ‰§è¡Œ --------------------------
def build_and_run_workflow():
    """æ„å»ºLangGraphå·¥ä½œæµå¹¶å¯åŠ¨æ‰§è¡Œ"""
    # 1. åˆå§‹åŒ–å·¥ä½œæµï¼ˆç»‘å®šçŠ¶æ€æ¨¡å‹ï¼‰
    workflow = StateGraph(WorkflowState)
    
    # 2. æ·»åŠ èŠ‚ç‚¹
    workflow.add_node("crawl", crawl_node)               # çˆ¬è™«èŠ‚ç‚¹
    workflow.add_node("summary", summary_node)           # æ‘˜è¦èŠ‚ç‚¹
    workflow.add_node("tts", tts_node)                   # TTSèŠ‚ç‚¹
    workflow.add_node("video_synthesis", video_synthesis_node)  # è§†é¢‘åˆæˆèŠ‚ç‚¹
    
    # 3. å®šä¹‰æ‰§è¡Œé¡ºåºï¼šçˆ¬è™«â†’æ‘˜è¦â†’TTSâ†’è§†é¢‘åˆæˆâ†’ç»“æŸ
    workflow.set_entry_point("crawl")
    workflow.add_edge("crawl", "summary")
    workflow.add_edge("summary", "tts")
    workflow.add_edge("tts", "video_synthesis")
    workflow.add_edge("video_synthesis", END)
    
    # 4. ç¼–è¯‘å·¥ä½œæµ
    app = workflow.compile()
    
    # 5. å¯åŠ¨å·¥ä½œæµï¼ˆåˆå§‹çŠ¶æ€ä¸ºç©ºï¼Œæ‰€æœ‰å­—æ®µé»˜è®¤å€¼ï¼‰
    initial_state = WorkflowState()
    result = app.invoke(initial_state)
    
    # 6. è¾“å‡ºæ‰§è¡Œç»“æœ
    print("=" * 60)
    print("LangGraphè‡ªåŠ¨åŒ–å·¥ä½œæµæ‰§è¡Œå®Œæˆ")
    print("=" * 60)
    print(f"çˆ¬è™«èŠ‚ç‚¹ï¼š{'âœ… æˆåŠŸ' if result.crawl_success else 'âŒ å¤±è´¥'}")
    print(f"æ‘˜è¦èŠ‚ç‚¹ï¼š{'âœ… æˆåŠŸ' if result.summary_success else 'âŒ å¤±è´¥'}")
    print(f"TTSèŠ‚ç‚¹ï¼š{'âœ… æˆåŠŸ' if result.tts_success else 'âŒ å¤±è´¥'}")
    print(f"è§†é¢‘åˆæˆèŠ‚ç‚¹ï¼š{'âœ… æˆåŠŸ' if result.video_success else 'âŒ å¤±è´¥'}")
    if result.audio_path:
        print(f"\nğŸ“Œ éŸ³é¢‘æ–‡ä»¶è·¯å¾„ï¼š{result.audio_path}")
    if result.video_path:
        print(f"ğŸ“Œ è§†é¢‘æ–‡ä»¶è·¯å¾„ï¼š{result.video_path}")
    if result.error_msg:
        print(f"\nâŒ é”™è¯¯è¯¦æƒ…ï¼š{result.error_msg}")
    print("=" * 60)

# -------------------------- æ‰§è¡Œå…¥å£ --------------------------
if __name__ == "__main__":
    build_and_run_workflow()
