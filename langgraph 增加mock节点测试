from pydantic import BaseModel
from typing import Optional, Literal
import logging
import os
import requests
from bs4 import BeautifulSoup
from gtts import gTTS
from moviepy.editor import AudioFileClip, ImageClip, ColorClip
from langchain.chat_models import ChatDeepSeek
from langchain.schema import HumanMessage
from langgraph.graph import StateGraph, END

# -------------------------- 1. å…¨å±€é…ç½® --------------------------
# æ–°å¢ï¼šå·¥ä½œæµæ¨¡å¼ï¼ˆçœŸå®/æ¨¡æ‹Ÿï¼‰
WORKFLOW_MODE: Literal["real", "mock"] = "mock"  # é»˜è®¤ä½¿ç”¨æ¨¡æ‹Ÿæ¨¡å¼

# DeepSeekå¤§æ¨¡å‹é…ç½®
DEEPSEEK_API_KEY = "sk-fcf857583a554b7885233424fe43d70a"
LLM_MODEL = "deepseek-chat"

# æ–‡ä»¶è·¯å¾„é…ç½®
OUTPUT_DIR = "output"
LOG_DIR = "logs"
BACKGROUND_IMAGE = "background.jpg"

# åˆ›å»ºå¿…è¦ç›®å½•
os.makedirs(OUTPUT_DIR, exist_ok=True)
os.makedirs(LOG_DIR, exist_ok=True)

# æ—¥å¿—é…ç½®
logging.basicConfig(
    filename=os.path.join(LOG_DIR, "workflow.log"),
    level=logging.INFO,
    format="%(asctime)s - %(levelname)s - %(message)s"
)

# -------------------------- 2. å·¥ä½œæµçŠ¶æ€æ¨¡å‹ --------------------------
class WorkflowState(BaseModel):
    """ç»Ÿä¸€ç®¡ç†å„èŠ‚ç‚¹è¾“å…¥/è¾“å‡ºæ•°æ®"""
    # çˆ¬è™«èŠ‚ç‚¹ç›¸å…³
    raw_text: Optional[str] = None
    crawl_success: bool = False
    
    # æ‘˜è¦ç”ŸæˆèŠ‚ç‚¹ç›¸å…³
    summary_text: Optional[str] = None
    summary_success: bool = False
    
    # TTSèŠ‚ç‚¹ç›¸å…³
    audio_path: Optional[str] = None
    tts_success: bool = False
    
    # è§†é¢‘åˆæˆèŠ‚ç‚¹ç›¸å…³
    video_path: Optional[str] = None
    video_success: bool = False
    
    # å…¨å±€ä¿¡æ¯
    error_msg: Optional[str] = None
    mode: str = WORKFLOW_MODE  # è®°å½•å½“å‰è¿è¡Œæ¨¡å¼

# -------------------------- 3. æ¨¡æ‹ŸèŠ‚ç‚¹ï¼ˆMock Nodesï¼‰ --------------------------
def mock_crawl_node(state: WorkflowState) -> WorkflowState:
    """æ¨¡æ‹Ÿçˆ¬è™«èŠ‚ç‚¹ï¼šè¿”å›é¢„è®¾çš„æµ‹è¯•æ–‡æœ¬"""
    logging.info("å¯åŠ¨æ¨¡æ‹Ÿçˆ¬è™«èŠ‚ç‚¹")
    try:
        # æ¨¡æ‹Ÿçˆ¬å–çš„å†…å®¹ï¼ˆåŒ…å«è¶³å¤Ÿé•¿åº¦çš„æ–‡æœ¬ï¼‰
        mock_text = """è¿™æ˜¯ä¸€æ®µæ¨¡æ‹Ÿçˆ¬å–çš„æ–‡æœ¬å†…å®¹ã€‚äººå·¥æ™ºèƒ½ï¼ˆAIï¼‰æ˜¯ç ”ç©¶ã€å¼€å‘ç”¨äºæ¨¡æ‹Ÿã€å»¶ä¼¸å’Œæ‰©å±•äººçš„æ™ºèƒ½çš„ç†è®ºã€æ–¹æ³•ã€æŠ€æœ¯åŠåº”ç”¨ç³»ç»Ÿçš„ä¸€é—¨æ–°çš„æŠ€æœ¯ç§‘å­¦ã€‚
        äººå·¥æ™ºèƒ½çš„ç ”ç©¶é¢†åŸŸåŒ…æ‹¬æœºå™¨äººã€è¯­è¨€è¯†åˆ«ã€å›¾åƒè¯†åˆ«ã€è‡ªç„¶è¯­è¨€å¤„ç†å’Œä¸“å®¶ç³»ç»Ÿç­‰ã€‚éšç€æŠ€æœ¯çš„å‘å±•ï¼ŒAIåœ¨åŒ»ç–—ã€é‡‘èã€æ•™è‚²ç­‰å¤šä¸ªé¢†åŸŸéƒ½æœ‰å¹¿æ³›åº”ç”¨ã€‚"""
        
        logging.info("æ¨¡æ‹Ÿçˆ¬è™«èŠ‚ç‚¹æ‰§è¡ŒæˆåŠŸ")
        return WorkflowState(
            **state.dict(),
            raw_text=mock_text,
            crawl_success=True
        )
    except Exception as e:
        error_detail = f"æ¨¡æ‹Ÿçˆ¬è™«èŠ‚ç‚¹å¤±è´¥ï¼š{str(e)}"
        logging.error(error_detail)
        return WorkflowState(** state.dict(), error_msg=error_detail)

def mock_summary_node(state: WorkflowState) -> WorkflowState:
    """æ¨¡æ‹Ÿæ‘˜è¦èŠ‚ç‚¹ï¼šè¿”å›é¢„è®¾çš„æ‘˜è¦ç»“æœ"""
    logging.info("å¯åŠ¨æ¨¡æ‹Ÿæ‘˜è¦èŠ‚ç‚¹")
    if not state.crawl_success:
        error_detail = "æ¨¡æ‹Ÿæ‘˜è¦èŠ‚ç‚¹è·³è¿‡ï¼šçˆ¬è™«æœªæˆåŠŸæ‰§è¡Œ"
        logging.warning(error_detail)
        return WorkflowState(**state.dict(), error_msg=error_detail)
    
    try:
        # æ¨¡æ‹Ÿæ‘˜è¦ç»“æœ
        mock_summary = "äººå·¥æ™ºèƒ½æ˜¯ä¸€é—¨ç ”ç©¶æ¨¡æ‹Ÿäººç±»æ™ºèƒ½çš„æŠ€æœ¯ç§‘å­¦ï¼Œæ¶µç›–æœºå™¨äººã€è¯­è¨€è¯†åˆ«ç­‰å¤šä¸ªé¢†åŸŸï¼Œç›®å‰å·²åœ¨åŒ»ç–—ã€é‡‘èç­‰è¡Œä¸šå¹¿æ³›åº”ç”¨ã€‚"
        
        logging.info("æ¨¡æ‹Ÿæ‘˜è¦èŠ‚ç‚¹æ‰§è¡ŒæˆåŠŸ")
        return WorkflowState(
            **state.dict(),
            summary_text=mock_summary,
            summary_success=True
        )
    except Exception as e:
        error_detail = f"æ¨¡æ‹Ÿæ‘˜è¦èŠ‚ç‚¹å¤±è´¥ï¼š{str(e)}"
        logging.error(error_detail)
        return WorkflowState(** state.dict(), error_msg=error_detail)

def mock_tts_node(state: WorkflowState) -> WorkflowState:
    """æ¨¡æ‹ŸTTSèŠ‚ç‚¹ï¼šç”ŸæˆåŒ…å«å›ºå®šå†…å®¹çš„éŸ³é¢‘æ–‡ä»¶"""
    logging.info("å¯åŠ¨æ¨¡æ‹ŸTTSèŠ‚ç‚¹")
    if not state.summary_success:
        error_detail = "æ¨¡æ‹ŸTTSèŠ‚ç‚¹è·³è¿‡ï¼šæ‘˜è¦æœªæˆåŠŸæ‰§è¡Œ"
        logging.warning(error_detail)
        return WorkflowState(**state.dict(), error_msg=error_detail)
    
    try:
        # ç”Ÿæˆæ¨¡æ‹ŸéŸ³é¢‘ï¼ˆä½¿ç”¨æ‘˜è¦æ–‡æœ¬ä½†æ ‡è®°ä¸ºæ¨¡æ‹Ÿï¼‰
        audio_path = os.path.join(OUTPUT_DIR, "mock_summary_audio.mp3")
        tts = gTTS(text=f"è¿™æ˜¯æ¨¡æ‹Ÿç”Ÿæˆçš„éŸ³é¢‘ã€‚{state.summary_text}", lang="zh-CN", slow=False)
        tts.save(audio_path)
        
        logging.info(f"æ¨¡æ‹ŸTTSèŠ‚ç‚¹æ‰§è¡ŒæˆåŠŸï¼ŒéŸ³é¢‘è·¯å¾„ï¼š{audio_path}")
        return WorkflowState(
            **state.dict(),
            audio_path=audio_path,
            tts_success=True
        )
    except Exception as e:
        error_detail = f"æ¨¡æ‹ŸTTSèŠ‚ç‚¹å¤±è´¥ï¼š{str(e)}"
        logging.error(error_detail)
        return WorkflowState(** state.dict(), error_msg=error_detail)

def mock_video_synthesis_node(state: WorkflowState) -> WorkflowState:
    """æ¨¡æ‹Ÿè§†é¢‘åˆæˆèŠ‚ç‚¹ï¼šä½¿ç”¨çº¯è‰²èƒŒæ™¯ä»£æ›¿çœŸå®å›¾ç‰‡"""
    logging.info("å¯åŠ¨æ¨¡æ‹Ÿè§†é¢‘åˆæˆèŠ‚ç‚¹")
    if not state.tts_success:
        error_detail = "æ¨¡æ‹Ÿè§†é¢‘èŠ‚ç‚¹è·³è¿‡ï¼šTTSæœªæˆåŠŸæ‰§è¡Œ"
        logging.warning(error_detail)
        return WorkflowState(**state.dict(), error_msg=error_detail)
    
    try:
        # è§†é¢‘è¾“å‡ºè·¯å¾„
        video_path = os.path.join(OUTPUT_DIR, "mock_final_video.mp4")
        
        # ä½¿ç”¨çº¯è‰²èƒŒæ™¯ï¼ˆé¿å…ä¾èµ–çœŸå®å›¾ç‰‡ï¼‰
        audio_clip = AudioFileClip(state.audio_path)
        # åˆ›å»º1280x720çš„è“è‰²èƒŒæ™¯
        image_clip = ColorClip(size=(1280, 720), color=(0, 0, 255))  # RGBè“è‰²
        
        # åŒæ­¥æ—¶é•¿
        image_clip = image_clip.set_duration(audio_clip.duration).set_fps(24)
        video_clip = image_clip.set_audio(audio_clip)
        
        # å¯¼å‡ºè§†é¢‘
        video_clip.write_videofile(video_path, codec="libx264", audio_codec="aac")
        
        # é‡Šæ”¾èµ„æº
        audio_clip.close()
        image_clip.close()
        video_clip.close()
        
        logging.info(f"æ¨¡æ‹Ÿè§†é¢‘åˆæˆèŠ‚ç‚¹æ‰§è¡ŒæˆåŠŸï¼Œè§†é¢‘è·¯å¾„ï¼š{video_path}")
        return WorkflowState(
            **state.dict(),
            video_path=video_path,
            video_success=True
        )
    except Exception as e:
        error_detail = f"æ¨¡æ‹Ÿè§†é¢‘èŠ‚ç‚¹å¤±è´¥ï¼š{str(e)}"
        logging.error(error_detail)
        return WorkflowState(** state.dict(), error_msg=error_detail)

# -------------------------- 4. çœŸå®èŠ‚ç‚¹ï¼ˆReal Nodesï¼‰ --------------------------
def crawl_node(state: WorkflowState) -> WorkflowState:
    """çœŸå®çˆ¬è™«èŠ‚ç‚¹ï¼šä»ç›®æ ‡URLæå–æ–‡æœ¬"""
    logging.info("å¯åŠ¨çœŸå®çˆ¬è™«èŠ‚ç‚¹")
    target_url = "https://example.com"  # å¯æ›¿æ¢ä¸ºå®é™…URL
    
    try:
        response = requests.get(target_url, timeout=10)
        response.raise_for_status()
        
        soup = BeautifulSoup(response.text, "html.parser")
        raw_text = soup.get_text().strip()
        
        if len(raw_text) < 50:
            raise ValueError(f"çˆ¬å–æ–‡æœ¬è¿‡çŸ­ï¼ˆä»…{len(raw_text)}å­—ç¬¦ï¼‰")
        
        logging.info(f"çœŸå®çˆ¬è™«èŠ‚ç‚¹æ‰§è¡ŒæˆåŠŸï¼Œæ–‡æœ¬é•¿åº¦ï¼š{len(raw_text)}å­—ç¬¦")
        return WorkflowState(
            **state.dict(),
            raw_text=raw_text,
            crawl_success=True
        )
    except Exception as e:
        error_detail = f"çœŸå®çˆ¬è™«èŠ‚ç‚¹å¤±è´¥ï¼š{str(e)}"
        logging.error(error_detail)
        return WorkflowState(** state.dict(), error_msg=error_detail)

def summary_node(state: WorkflowState) -> WorkflowState:
    """çœŸå®æ‘˜è¦èŠ‚ç‚¹ï¼šè°ƒç”¨DeepSeekç”Ÿæˆæ‘˜è¦"""
    logging.info("å¯åŠ¨çœŸå®æ‘˜è¦èŠ‚ç‚¹")
    if not state.crawl_success:
        error_detail = "çœŸå®æ‘˜è¦èŠ‚ç‚¹è·³è¿‡ï¼šçˆ¬è™«æœªæˆåŠŸæ‰§è¡Œ"
        logging.warning(error_detail)
        return WorkflowState(**state.dict(), error_msg=error_detail)
    
    try:
        llm = ChatDeepSeek(
            api_key=DEEPSEEK_API_KEY,
            model=LLM_MODEL,
            temperature=0.6
        )
        
        prompt = f"å°†ä»¥ä¸‹æ–‡æœ¬æ€»ç»“ä¸º100å­—å†…æ ¸å¿ƒæ‘˜è¦ï¼š\n{state.raw_text}"
        response = llm([HumanMessage(content=prompt)])
        summary_text = response.content.strip()
        
        logging.info("çœŸå®æ‘˜è¦èŠ‚ç‚¹æ‰§è¡ŒæˆåŠŸ")
        return WorkflowState(
            **state.dict(),
            summary_text=summary_text,
            summary_success=True
        )
    except Exception as e:
        error_detail = f"çœŸå®æ‘˜è¦èŠ‚ç‚¹å¤±è´¥ï¼š{str(e)}"
        logging.error(error_detail)
        return WorkflowState(** state.dict(), error_msg=error_detail)

def tts_node(state: WorkflowState) -> WorkflowState:
    """çœŸå®TTSèŠ‚ç‚¹ï¼šå°†æ‘˜è¦è½¬ä¸ºéŸ³é¢‘"""
    logging.info("å¯åŠ¨çœŸå®TTSèŠ‚ç‚¹")
    if not state.summary_success:
        error_detail = "çœŸå®TTSèŠ‚ç‚¹è·³è¿‡ï¼šæ‘˜è¦æœªæˆåŠŸæ‰§è¡Œ"
        logging.warning(error_detail)
        return WorkflowState(**state.dict(), error_msg=error_detail)
    
    try:
        audio_path = os.path.join(OUTPUT_DIR, "summary_audio.mp3")
        tts = gTTS(text=state.summary_text, lang="zh-CN", slow=False)
        tts.save(audio_path)
        
        logging.info(f"çœŸå®TTSèŠ‚ç‚¹æ‰§è¡ŒæˆåŠŸï¼ŒéŸ³é¢‘è·¯å¾„ï¼š{audio_path}")
        return WorkflowState(
            **state.dict(),
            audio_path=audio_path,
            tts_success=True
        )
    except Exception as e:
        error_detail = f"çœŸå®TTSèŠ‚ç‚¹å¤±è´¥ï¼š{str(e)}"
        logging.error(error_detail)
        return WorkflowState(** state.dict(), error_msg=error_detail)

def video_synthesis_node(state: WorkflowState) -> WorkflowState:
    """çœŸå®è§†é¢‘åˆæˆèŠ‚ç‚¹ï¼šä½¿ç”¨æŒ‡å®šèƒŒæ™¯å›¾ç‰‡"""
    logging.info("å¯åŠ¨çœŸå®è§†é¢‘åˆæˆèŠ‚ç‚¹")
    if not state.tts_success:
        error_detail = "çœŸå®è§†é¢‘èŠ‚ç‚¹è·³è¿‡ï¼šTTSæœªæˆåŠŸæ‰§è¡Œ"
        logging.warning(error_detail)
        return WorkflowState(**state.dict(), error_msg=error_detail)
    
    try:
        if not os.path.exists(BACKGROUND_IMAGE):
            raise FileNotFoundError(f"èƒŒæ™¯å›¾ç‰‡ä¸å­˜åœ¨ï¼š{BACKGROUND_IMAGE}")
        
        video_path = os.path.join(OUTPUT_DIR, "final_video.mp4")
        
        audio_clip = AudioFileClip(state.audio_path)
        image_clip = ImageClip(BACKGROUND_IMAGE)
        
        image_clip = image_clip.set_duration(audio_clip.duration).set_fps(24)
        video_clip = image_clip.set_audio(audio_clip)
        
        video_clip.write_videofile(video_path, codec="libx264", audio_codec="aac")
        
        audio_clip.close()
        image_clip.close()
        video_clip.close()
        
        logging.info(f"çœŸå®è§†é¢‘åˆæˆèŠ‚ç‚¹æ‰§è¡ŒæˆåŠŸï¼Œè§†é¢‘è·¯å¾„ï¼š{video_path}")
        return WorkflowState(
            **state.dict(),
            video_path=video_path,
            video_success=True
        )
    except Exception as e:
        error_detail = f"çœŸå®è§†é¢‘èŠ‚ç‚¹å¤±è´¥ï¼š{str(e)}"
        logging.error(error_detail)
        return WorkflowState(** state.dict(), error_msg=error_detail)

# -------------------------- 5. å·¥ä½œæµæ­å»ºä¸æ‰§è¡Œ --------------------------
def build_and_run_workflow():
    """æ ¹æ®æ¨¡å¼æ„å»ºå¹¶æ‰§è¡Œå·¥ä½œæµ"""
    workflow = StateGraph(WorkflowState)
    
    # æ ¹æ®è¿è¡Œæ¨¡å¼é€‰æ‹©èŠ‚ç‚¹
    if WORKFLOW_MODE == "mock":
        logging.info("ä½¿ç”¨æ¨¡æ‹Ÿå·¥ä½œæµæ¨¡å¼")
        workflow.add_node("crawl", mock_crawl_node)
        workflow.add_node("summary", mock_summary_node)
        workflow.add_node("tts", mock_tts_node)
        workflow.add_node("video_synthesis", mock_video_synthesis_node)
    else:
        logging.info("ä½¿ç”¨çœŸå®å·¥ä½œæµæ¨¡å¼")
        workflow.add_node("crawl", crawl_node)
        workflow.add_node("summary", summary_node)
        workflow.add_node("tts", tts_node)
        workflow.add_node("video_synthesis", video_synthesis_node)
    
    # å®šä¹‰æ‰§è¡Œé¡ºåº
    workflow.set_entry_point("crawl")
    workflow.add_edge("crawl", "summary")
    workflow.add_edge("summary", "tts")
    workflow.add_edge("tts", "video_synthesis")
    workflow.add_edge("video_synthesis", END)
    
    # ç¼–è¯‘å¹¶æ‰§è¡Œ
    app = workflow.compile()
    initial_state = WorkflowState()
    result = app.invoke(initial_state)
    
    # è¾“å‡ºç»“æœ
    print("=" * 60)
    print(f"LangGraphå·¥ä½œæµæ‰§è¡Œå®Œæˆï¼ˆæ¨¡å¼ï¼š{WORKFLOW_MODE}ï¼‰")
    print("=" * 60)
    print(f"çˆ¬è™«èŠ‚ç‚¹ï¼š{'âœ… æˆåŠŸ' if result.crawl_success else 'âŒ å¤±è´¥'}")
    print(f"æ‘˜è¦èŠ‚ç‚¹ï¼š{'âœ… æˆåŠŸ' if result.summary_success else 'âŒ å¤±è´¥'}")
    print(f"TTSèŠ‚ç‚¹ï¼š{'âœ… æˆåŠŸ' if result.tts_success else 'âŒ å¤±è´¥'}")
    print(f"è§†é¢‘åˆæˆèŠ‚ç‚¹ï¼š{'âœ… æˆåŠŸ' if result.video_success else 'âŒ å¤±è´¥'}")
    if result.audio_path:
        print(f"\nğŸ“Œ éŸ³é¢‘æ–‡ä»¶è·¯å¾„ï¼š{result.audio_path}")
    if result.video_path:
        print(f"ğŸ“Œ è§†é¢‘æ–‡ä»¶è·¯å¾„ï¼š{result.video_path}")
    if result.error_msg:
        print(f"\nâŒ é”™è¯¯è¯¦æƒ…ï¼š{result.error_msg}")
    print("=" * 60)

# -------------------------- æ‰§è¡Œå…¥å£ --------------------------
if __name__ == "__main__":
    build_and_run_workflow()
